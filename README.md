# Kopia FS Repo Recovery Tool

This tool will help you recover a kopia filesystem-based repository suffering from missing or damaged blobs if a secondary copy of this repository exists (i.e. using `kopia repo sync` to backup the repository accordance with a "3-2-1 data protection strategy")

This of course assumes that the device your primary repository on is still otherwise functioning and is in good working order, been scanned and fixed with fsck and passed SMART diagnostics etc.

Slow access and bad sectors are signs that the device is on its way out, so even if you recover your repository using this tool you should consider replacing the drive depending on your circumstances.

If you are lucky, this tool will save you from having to run `kopia repository repair filesystem`.

## Important

This utility is supplied without any guarantees, warrantees and statements or assertions as to fitness to purpose whatsoever.

The recovery strategy used by this utility requires:

  1. having a pre-existing copy of the damaged repository;
  2. there being no damage to the repository metadata;
  3. kopia being able to complete a snapshot verify run; and
  4. the snapshot verify log output to match the log output generated by version 0.22.1 of kopia

## How it works

### Identify Missing Blobs

Run kopia snapshot verify and capture its logs. Allow many errors so that it doesn't stop verification after the first:

```shell
kopia snapshot verify --verify-files-percent=100 --file-parallelism=10 --parallel=10 --max-errors=999999999 2>&1 | tee kopia-snapshot-verify-log.txt
```

Then run this tool to identify missing blobs:

```shell
kopia-fsrepo-recovery extract-from-log ./kopia-snapshot-verify-log.txt
```

It will parse the log and attempt to identify missing blobs and save them in a file (by default `missing-blobs.json`).

### Check that your secondary repository has required blobs

Mount/sync down your secondary repository and run the tool to validate that missing blobs are present and greater then zero bytes:

```shell
kopia-fsrepo-recovery check ./source/
[2025-12-02T06:51:42Z INFO  kopia_fsrepo_recovery::check] Checking source repository from './source/'
███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████ 135/135
[2025-12-02T06:51:42Z INFO  kopia_fsrepo_recovery::check] All missing blobs present and accounted for in source repo
```

### Copy missing blobs from secondary repo to primary

Do a dry run, observe log and see what it would do:

```shell
./kopia-fsrepo-recovery restore ./source ./dest
...
[2025-12-02T06:53:23Z INFO  kopia_fsrepo_recovery::restore] 135 blobs would be restored from source repo
```

If satisfied, pass the `for-real` flag to copy blobs across:

```shell
./kopia-fsrepo-recovery restore ./source ./dest -f
[2025-12-02T07:11:35Z INFO  kopia_fsrepo_recovery::check] Checking source repository from '/home/user/scratch/source'
███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████ 135/135
...
[2025-12-02T07:12:04Z INFO  kopia_fsrepo_recovery::restore] 135 blobs were restored from source repo
```

### Re-verify

Re-run kopia snapshot verify and capture its logs. Hopefully this time there are no errors relating to missing or unreadable blobs:

```shell
kopia snapshot verify --verify-files-percent=100 --file-parallelism=10 --parallel=10 --max-errors=999999999 2>&1 | tee kopia-snapshot-verify-log-post-restore.txt
```
